version: '{build}'

platform:
  - x64

clone_folder: C:\projects\docker-toolbox-portable
test: off

environment:
  JAVA_HOME: C:\Program Files\Java\jdk1.8.0
  GOPATH: C:\gopath
  GOROOT: C:\go\
  GOVERSION: 1.11.5

install:
  - ps: choco install ant
  - ps: Install-Product node 8
  - ps: $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
  - cmd: set PATH=%GOPATH%\bin;%GOPATH%\bin\windows_386;%GOROOT%bin;%PATH%
  - rmdir c:\go /s /q
  - curl -fsS -o go%GOVERSION%.windows-amd64.zip https://storage.googleapis.com/golang/go%GOVERSION%.windows-amd64.zip
  - 7z x go%GOVERSION%.windows-amd64.zip -y -oC:\ > NUL
  - java -version
  - ant -version
  - node --version
  - npm --version
  - go version
  - go env

configuration:
  - Release

before_build:
  - git clone https://github.com/portapps/portapps C:\projects\portapps

build_script:
  - ant release

after_build:
  - ps: |
      $env:APP_VERSION = Get-Content C:\projects\docker-toolbox-portable\bin\tmp\version.dat -Raw
      Write-Host "App version: $env:APP_VERSION"

artifacts:
  - path: 'bin\release\*'
    name: release

deploy:
  tag: $(APP_VERSION)
  release: $(APP_VERSION)
  description: 'New release: $(APP_VERSION)'
  provider: GitHub
  auth_token:
    secure: jFbo7oVnD9HZL5LL+nE0IC8x6xHlqvkeVDeMj/WS+Rk9GanjBKlnlvTjeHsNlo+/
  artifact: release
  draft: true
  prerelease: false
  on:
    branch: master

notifications:
  - provider: Webhook
    url:
      secure: 3V6QSptnPc6MYQn2S8/BzENJ5YDEn94VmCi2xmTCa0tPSUswf2HcFG9Uwa9j8jcnBh7ZitwwLxCT+Y9a+VFrbp816MEPovhoobQkZZKjo2euc+s/s3uXYuy4tS35QYKjr7QgK3yNTzzT6qbhoGPmYg==
    method: post
